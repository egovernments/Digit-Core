-- Create sequence for scan results
CREATE SEQUENCE IF NOT EXISTS seq_eg_malware_scan_results;

-- Create malware scan results table
CREATE TABLE IF NOT EXISTS eg_malware_scan_results (
    id VARCHAR(64) NOT NULL,
    filestore_id VARCHAR(64) NOT NULL,
    tenant_id VARCHAR(256) NOT NULL,
    file_name VARCHAR(512),
    file_path VARCHAR(1024),
    file_hash VARCHAR(64),
    file_size BIGINT,
    status VARCHAR(32) NOT NULL,
    virus_name VARCHAR(256),
    scan_engine VARCHAR(64),
    scan_engine_version VARCHAR(32),
    scan_duration_ms BIGINT,
    raw_response TEXT,
    quarantined BOOLEAN DEFAULT FALSE,
    quarantine_path VARCHAR(1024),
    notification_sent BOOLEAN DEFAULT FALSE,
    created_by VARCHAR(64),
    created_time BIGINT,
    last_modified_by VARCHAR(64),
    last_modified_time BIGINT,

    CONSTRAINT pk_eg_malware_scan_results PRIMARY KEY (id),
    CONSTRAINT uk_eg_malware_scan_results_filestore UNIQUE (filestore_id, tenant_id)
);

-- Create indexes for common queries
CREATE INDEX IF NOT EXISTS idx_eg_malware_scan_results_tenant ON eg_malware_scan_results(tenant_id);
CREATE INDEX IF NOT EXISTS idx_eg_malware_scan_results_status ON eg_malware_scan_results(status);
CREATE INDEX IF NOT EXISTS idx_eg_malware_scan_results_created ON eg_malware_scan_results(created_time);
CREATE INDEX IF NOT EXISTS idx_eg_malware_scan_results_file_hash ON eg_malware_scan_results(file_hash);

-- Create malware scan audit log table
CREATE TABLE IF NOT EXISTS eg_malware_scan_audit (
    id SERIAL PRIMARY KEY,
    scan_result_id VARCHAR(64) NOT NULL,
    filestore_id VARCHAR(64) NOT NULL,
    tenant_id VARCHAR(256) NOT NULL,
    action VARCHAR(64) NOT NULL,
    action_details TEXT,
    action_time BIGINT NOT NULL,
    action_by VARCHAR(64)
);

-- Create index for audit queries
CREATE INDEX IF NOT EXISTS idx_eg_malware_scan_audit_scan_result ON eg_malware_scan_audit(scan_result_id);
CREATE INDEX IF NOT EXISTS idx_eg_malware_scan_audit_filestore ON eg_malware_scan_audit(filestore_id);
CREATE INDEX IF NOT EXISTS idx_eg_malware_scan_audit_time ON eg_malware_scan_audit(action_time);
