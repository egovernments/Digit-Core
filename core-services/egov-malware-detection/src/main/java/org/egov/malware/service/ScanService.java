package org.egov.malware.service;

import lombok.extern.slf4j.Slf4j;
import org.egov.malware.model.*;
import org.egov.malware.producer.ScanResultProducer;
import org.egov.malware.validator.FileExistsValidator;
import org.egov.malware.validator.FileSizeValidator;
import org.egov.malware.validator.ScanRequestValidator;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
@Slf4j
public class ScanService {

    private final ScanRequestValidator scanRequestValidator;
    private final FileSizeValidator fileSizeValidator;
    private final FileExistsValidator fileExistsValidator;
    private final FileRetrievalService fileRetrievalService;
    private final ClamAVService clamAVService;
    private final EnrichmentService enrichmentService;
    private final QuarantineService quarantineService;
    private final NotificationService notificationService;
    private final ScanResultProducer scanResultProducer;
    private final ScanAuditService scanAuditService;

    @Autowired
    public ScanService(ScanRequestValidator scanRequestValidator,
                       FileSizeValidator fileSizeValidator,
                       FileExistsValidator fileExistsValidator,
                       FileRetrievalService fileRetrievalService,
                       ClamAVService clamAVService,
                       EnrichmentService enrichmentService,
                       QuarantineService quarantineService,
                       NotificationService notificationService,
                       ScanResultProducer scanResultProducer,
                       ScanAuditService scanAuditService) {
        this.scanRequestValidator = scanRequestValidator;
        this.fileSizeValidator = fileSizeValidator;
        this.fileExistsValidator = fileExistsValidator;
        this.fileRetrievalService = fileRetrievalService;
        this.clamAVService = clamAVService;
        this.enrichmentService = enrichmentService;
        this.quarantineService = quarantineService;
        this.notificationService = notificationService;
        this.scanResultProducer = scanResultProducer;
        this.scanAuditService = scanAuditService;
    }

    /**
     * Processes a malware scan request for an uploaded file.
     *
     * @param scanRequest The scan request received from egov-filestore
     * @return ScanResult containing the scan outcome
     */
    public ScanResult scan(MalwareScanRequest scanRequest) {
        log.info("------------------------------------------------------------");
        log.info("[SCAN-SERVICE] Starting malware scan workflow");
        log.info("[SCAN-SERVICE] fileStoreId: {}", scanRequest.getFileStoreId());
        log.info("[SCAN-SERVICE] tenantId: {}", scanRequest.getTenantId());
        log.info("[SCAN-SERVICE] fileName: {}", scanRequest.getFileName());
        log.info("------------------------------------------------------------");

        try {
            // Step 1: Validate request
            log.info("[SCAN-SERVICE] STEP 1: Validating scan request...");
            scanRequestValidator.validate(scanRequest);
            log.info("[SCAN-SERVICE] STEP 1: Request validation PASSED");

            // Step 2: Fetch file from storage
            log.info("[SCAN-SERVICE] STEP 2: Fetching file from storage...");
            log.info("[SCAN-SERVICE] STEP 2: fileSource={}, filePath={}", scanRequest.getFileSource(), scanRequest.getFilePath());
            FileInfo fileInfo = fileRetrievalService.fetchFile(scanRequest);
            log.info("[SCAN-SERVICE] STEP 2: File fetched - size={} bytes, hash={}", fileInfo.getFileSize(), fileInfo.getFileHash());

            // Step 3: Validate file exists and size
            log.info("[SCAN-SERVICE] STEP 3: Validating file exists...");
            fileExistsValidator.validate(fileInfo);
            log.info("[SCAN-SERVICE] STEP 3: File exists validation PASSED");

            log.info("[SCAN-SERVICE] STEP 4: Validating file size...");
            fileSizeValidator.validate(fileInfo);
            log.info("[SCAN-SERVICE] STEP 4: File size validation PASSED");

            // Step 5: Scan file with ClamAV
            log.info("[SCAN-SERVICE] STEP 5: Scanning file with ClamAV...");
            log.info("[SCAN-SERVICE] STEP 5: Sending {} bytes to ClamAV daemon", fileInfo.getFileSize());
            ClamAVResponse clamAVResponse = clamAVService.scanFile(fileInfo);
            log.info("[SCAN-SERVICE] STEP 5: ClamAV response - clean={}, virusName={}, error={}",
                    clamAVResponse.isClean(), clamAVResponse.getVirusName(), clamAVResponse.getErrorMessage());
            log.info("[SCAN-SERVICE] STEP 5: Raw ClamAV response: {}", clamAVResponse.getRawResponse());

            // Step 6: Build scan result
            log.info("[SCAN-SERVICE] STEP 6: Building scan result...");
            ScanResult scanResult = enrichmentService.buildScanResult(fileInfo, clamAVResponse);
            log.info("[SCAN-SERVICE] STEP 6: Scan result built - status={}", scanResult.getStatus());

            // Step 7: Enrich scan result with UUID and audit details
            log.info("[SCAN-SERVICE] STEP 7: Enriching scan result with UUID and audit details...");
            scanResult = enrichmentService.enrichScanResult(scanResult, scanRequest.getUploadedBy());
            log.info("[SCAN-SERVICE] STEP 7: Scan result enriched - id={}", scanResult.getId());

            // Audit: Log scan completion based on status
            if (scanResult.getStatus() == ScanStatus.CLEAN) {
                scanAuditService.logScanCompletedClean(scanResult);
            } else if (scanResult.getStatus() == ScanStatus.ERROR) {
                scanAuditService.logScanFailed(scanResult, clamAVResponse.getErrorMessage());
            }

            // Step 8: Handle infected file
            if (scanResult.getStatus() == ScanStatus.INFECTED) {
                log.warn("************************************************************");
                log.warn("[SCAN-SERVICE] !!! MALWARE DETECTED !!!");
                log.warn("[SCAN-SERVICE] fileStoreId: {}", scanRequest.getFileStoreId());
                log.warn("[SCAN-SERVICE] virusName: {}", scanResult.getVirusName());
                log.warn("************************************************************");

                // Audit: Log malware detection
                scanAuditService.logScanCompletedInfected(scanResult);

                // Step 8a: Quarantine infected file
                log.info("[SCAN-SERVICE] STEP 8a: Quarantining infected file...");
                scanAuditService.logQuarantineStarted(scanResult);
                QuarantineResult quarantineResult = quarantineService.quarantineFile(
                        fileInfo, scanResult.getVirusName());
                scanResult = enrichmentService.updateQuarantineInfo(scanResult, quarantineResult);
                log.info("[SCAN-SERVICE] STEP 8a: Quarantine complete - success={}", quarantineResult.isSuccess());

                // Audit: Log quarantine result
                if (quarantineResult.isSuccess()) {
                    scanAuditService.logQuarantineCompleted(scanResult);
                    if (quarantineResult.isOriginalDeleted()) {
                        scanAuditService.logOriginalDeleted(scanResult);
                    }
                } else {
                    scanAuditService.logQuarantineFailed(scanResult, quarantineResult.getErrorMessage());
                }

                // Step 8b: Send notifications
                log.info("[SCAN-SERVICE] STEP 8b: Sending notifications...");
                NotificationResult notificationResult = notificationService.sendInfectedFileAlert(scanResult);
                scanResult = enrichmentService.updateNotificationInfo(scanResult, notificationResult);
                log.info("[SCAN-SERVICE] STEP 8b: Notifications sent - email={}, slack={}",
                        notificationResult.isEmailSent(), notificationResult.isSlackSent());

                // Audit: Log notification results
                if (notificationResult.isSlackSent()) {
                    scanAuditService.logSlackNotificationSent(scanResult);
                } else if (notificationResult.getSlackError() != null) {
                    scanAuditService.logSlackNotificationFailed(scanResult, notificationResult.getSlackError());
                }
                if (notificationResult.isEmailSent()) {
                    scanAuditService.logEmailNotificationSent(scanResult, "configured recipients");
                } else if (notificationResult.getEmailError() != null) {
                    scanAuditService.logEmailNotificationFailed(scanResult, notificationResult.getEmailError());
                }

            } else if (scanResult.getStatus() == ScanStatus.CLEAN) {
                log.info("[SCAN-SERVICE] File is CLEAN - fileStoreId: {}", scanRequest.getFileStoreId());
            } else if (scanResult.getStatus() == ScanStatus.ERROR) {
                log.error("[SCAN-SERVICE] Scan ERROR - fileStoreId: {}, error: {}",
                        scanRequest.getFileStoreId(), clamAVResponse.getErrorMessage());
            }

            // Step 9: Persist scan result (async via Kafka)
            log.info("[SCAN-SERVICE] STEP 9: Persisting scan result to database via Kafka...");
            scanResultProducer.send(scanResult);
            log.info("[SCAN-SERVICE] STEP 9: Scan result sent to persistence topic");

            log.info("------------------------------------------------------------");
            log.info("[SCAN-SERVICE] SCAN COMPLETED SUCCESSFULLY");
            log.info("[SCAN-SERVICE] fileStoreId: {}", scanRequest.getFileStoreId());
            log.info("[SCAN-SERVICE] status: {}", scanResult.getStatus());
            log.info("[SCAN-SERVICE] infected: {}", scanResult.getInfected());
            log.info("[SCAN-SERVICE] duration: {}ms", scanResult.getScanDurationMs());
            log.info("------------------------------------------------------------");

            return scanResult;

        } catch (Exception e) {
            log.error("------------------------------------------------------------");
            log.error("[SCAN-SERVICE] SCAN FAILED WITH EXCEPTION");
            log.error("[SCAN-SERVICE] fileStoreId: {}", scanRequest.getFileStoreId());
            log.error("[SCAN-SERVICE] Exception type: {}", e.getClass().getSimpleName());
            log.error("[SCAN-SERVICE] Exception message: {}", e.getMessage());
            log.error("[SCAN-SERVICE] Stack trace:", e);
            log.error("------------------------------------------------------------");

            // Create error scan result
            ScanResult errorResult = ScanResult.builder()
                    .fileStoreId(scanRequest.getFileStoreId())
                    .tenantId(scanRequest.getTenantId())
                    .fileName(scanRequest.getFileName())
                    .filePath(scanRequest.getFilePath())
                    .status(ScanStatus.ERROR)
                    .rawResponse("Scan failed: " + e.getMessage())
                    .build();

            errorResult = enrichmentService.enrichScanResult(errorResult, scanRequest.getUploadedBy());

            // Audit: Log scan failure
            scanAuditService.logScanFailed(errorResult, e.getMessage());

            // Persist error result
            log.info("[SCAN-SERVICE] Persisting error result...");
            scanResultProducer.send(errorResult);

            return errorResult;
        }
    }

    public boolean isReady() {
        return clamAVService.isAvailable();
    }

    public String getClamAVVersion() {
        return clamAVService.getVersion();
    }
}
