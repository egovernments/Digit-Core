package org.egov.malware.service;

import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.egov.malware.config.MalwareDetectionConfig;
import org.egov.malware.model.EmailRequest;
import org.egov.malware.model.NotificationResult;
import org.egov.malware.model.ScanResult;
import org.egov.malware.model.SlackMessage;
import org.egov.tracer.kafka.CustomKafkaTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.stereotype.Service;

import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.util.Arrays;
import java.util.HashSet;
import java.util.Set;
import java.util.stream.Collectors;

@Service
@Slf4j
public class NotificationService {

    private static final String MODE_DIRECT = "direct";
    private static final String MODE_KAFKA = "kafka";

    private final MalwareDetectionConfig config;
    private final ObjectMapper objectMapper;
    private final CustomKafkaTemplate<String, Object> kafkaTemplate;
    private JavaMailSender mailSender;

    @Autowired
    public NotificationService(MalwareDetectionConfig config,
                               ObjectMapper objectMapper,
                               CustomKafkaTemplate<String, Object> kafkaTemplate) {
        this.config = config;
        this.objectMapper = objectMapper;
        this.kafkaTemplate = kafkaTemplate;
    }

    @Autowired(required = false)
    public void setMailSender(JavaMailSender mailSender) {
        this.mailSender = mailSender;
    }

    public NotificationResult sendInfectedFileAlert(ScanResult scanResult) {
        log.info("Sending infected file alert for fileStoreId: {}", scanResult.getFileStoreId());

        boolean slackSent = false;
        boolean emailSent = false;
        String slackError = null;
        String emailError = null;

        // Send Slack notification
        if (config.isSlackEnabled()) {
            try {
                sendSlackNotification(scanResult);
                slackSent = true;
                log.info("Slack notification sent for fileStoreId: {}", scanResult.getFileStoreId());
            } catch (Exception e) {
                slackError = e.getMessage();
                log.error("Failed to send Slack notification for fileStoreId: {}",
                        scanResult.getFileStoreId(), e);
            }
        }

        // Send Email notification based on configured mode
        if (config.isMailEnabled()) {
            try {
                String mode = config.getMailNotificationMode();
                log.info("Email notification mode: {}", mode);

                if (MODE_KAFKA.equalsIgnoreCase(mode)) {
                    // Send via Kafka to egov-notification-mail service
                    sendEmailViaKafka(scanResult);
                    emailSent = true;
                    log.info("Email notification sent via Kafka for fileStoreId: {}", scanResult.getFileStoreId());
                } else if (MODE_DIRECT.equalsIgnoreCase(mode) && mailSender != null) {
                    // Send directly via JavaMailSender
                    sendEmailDirect(scanResult);
                    emailSent = true;
                    log.info("Email notification sent directly for fileStoreId: {}", scanResult.getFileStoreId());
                } else {
                    log.warn("Email mode '{}' not supported or mailSender not configured", mode);
                }
            } catch (Exception e) {
                emailError = e.getMessage();
                log.error("Failed to send Email notification for fileStoreId: {}",
                        scanResult.getFileStoreId(), e);
            }
        }

        return NotificationResult.builder()
                .slackSent(slackSent)
                .emailSent(emailSent)
                .slackError(slackError)
                .emailError(emailError)
                .build();
    }

    // ==================== SLACK NOTIFICATION ====================

    private void sendSlackNotification(ScanResult scanResult) throws Exception {
        String alertMessage = buildSlackAlertMessage(scanResult);

        SlackMessage slackMessage = SlackMessage.builder()
                .channel(config.getSlackChannel())
                .username(config.getSlackUsername())
                .text(alertMessage)
                .iconEmoji(config.getSlackIconEmoji())
                .build();

        String payload = objectMapper.writeValueAsString(slackMessage);

        // Send using URL-encoded payload format as specified in the curl command
        URL url = new URL(config.getSlackWebhookUrl());
        HttpURLConnection connection = (HttpURLConnection) url.openConnection();

        try {
            connection.setRequestMethod("POST");
            connection.setDoOutput(true);
            connection.setRequestProperty("Content-Type", "application/x-www-form-urlencoded");

            String encodedPayload = "payload=" + URLEncoder.encode(payload, StandardCharsets.UTF_8.toString());

            try (OutputStream os = connection.getOutputStream()) {
                os.write(encodedPayload.getBytes(StandardCharsets.UTF_8));
                os.flush();
            }

            int responseCode = connection.getResponseCode();
            if (responseCode != HttpURLConnection.HTTP_OK) {
                throw new RuntimeException("Slack webhook returned status code: " + responseCode);
            }

            log.debug("Slack webhook response code: {}", responseCode);

        } finally {
            connection.disconnect();
        }
    }

    private String buildSlackAlertMessage(ScanResult scanResult) {
        StringBuilder sb = new StringBuilder();
        sb.append("*MALWARE DETECTED*\n\n");
        sb.append("*File Information:*\n");
        sb.append("- FileStore ID: `").append(scanResult.getFileStoreId()).append("`\n");
        sb.append("- Tenant ID: `").append(scanResult.getTenantId()).append("`\n");
        sb.append("- File Name: `").append(scanResult.getFileName()).append("`\n");
        sb.append("- File Path: `").append(scanResult.getFilePath()).append("`\n");
        sb.append("- File Hash (SHA-256): `").append(scanResult.getFileHash()).append("`\n");
        sb.append("- File Size: ").append(formatFileSize(scanResult.getFileSize())).append("\n\n");

        sb.append("*Scan Details:*\n");
        sb.append("- Virus Name: `").append(scanResult.getVirusName()).append("`\n");
        sb.append("- Scan Engine: ").append(scanResult.getScanEngine()).append("\n");
        sb.append("- Scan Duration: ").append(scanResult.getScanDurationMs()).append("ms\n\n");

        if (scanResult.getQuarantined() != null && scanResult.getQuarantined()) {
            sb.append("*Action Taken:* File has been quarantined\n");
            sb.append("- Quarantine Path: `").append(scanResult.getQuarantinePath()).append("`\n");
        } else {
            sb.append("*Action Required:* Please review and take appropriate action\n");
        }

        sb.append("\n_Scan Time: ").append(java.time.Instant.ofEpochMilli(scanResult.getCreatedTime())).append("_");

        return sb.toString();
    }

    // ==================== EMAIL VIA KAFKA (egov-notification-mail) ====================

    private void sendEmailViaKafka(ScanResult scanResult) {
        String subject = String.format("[ALERT] %s - Malware Detected: %s",
                config.getMailAlertSubject(), scanResult.getVirusName());

        String body = buildHtmlEmailBody(scanResult);

        String recipientsConfig = config.getMailAlertRecipients();
        log.info("[EMAIL-KAFKA] Configured recipients from config: '{}'", recipientsConfig);

        Set<String> recipients = Arrays.stream(recipientsConfig.split(","))
                .map(String::trim)
                .collect(Collectors.toSet());

        log.info("[EMAIL-KAFKA] Parsed recipients set: {}", recipients);

        EmailRequest.Email email = EmailRequest.Email.builder()
                .emailTo(recipients)
                .subject(subject)
                .body(body)
                .tenantId(scanResult.getTenantId())
                .isHTML(true)
                .build();

        EmailRequest emailRequest = EmailRequest.builder()
                .email(email)
                .build();

        log.info("[EMAIL-KAFKA] Publishing to topic: {}, recipients: {}", config.getEmailNotificationTopic(), recipients);
        kafkaTemplate.send(config.getEmailNotificationTopic(), emailRequest);
        log.info("[EMAIL-KAFKA] Email notification published to Kafka successfully");
    }

    private String buildHtmlEmailBody(ScanResult scanResult) {
        StringBuilder sb = new StringBuilder();
        sb.append("<html><body>");
        sb.append("<h2 style='color: #d32f2f;'>MALWARE DETECTION ALERT</h2>");
        sb.append("<hr/>");

        sb.append("<h3>File Information</h3>");
        sb.append("<table border='1' cellpadding='8' cellspacing='0'>");
        sb.append("<tr><td><strong>FileStore ID</strong></td><td>").append(scanResult.getFileStoreId()).append("</td></tr>");
        sb.append("<tr><td><strong>Tenant ID</strong></td><td>").append(scanResult.getTenantId()).append("</td></tr>");
        sb.append("<tr><td><strong>File Name</strong></td><td>").append(scanResult.getFileName()).append("</td></tr>");
        sb.append("<tr><td><strong>File Path</strong></td><td>").append(scanResult.getFilePath()).append("</td></tr>");
        sb.append("<tr><td><strong>File Hash (SHA-256)</strong></td><td><code>").append(scanResult.getFileHash()).append("</code></td></tr>");
        sb.append("<tr><td><strong>File Size</strong></td><td>").append(formatFileSize(scanResult.getFileSize())).append("</td></tr>");
        sb.append("</table>");

        sb.append("<h3>Scan Details</h3>");
        sb.append("<table border='1' cellpadding='8' cellspacing='0'>");
        sb.append("<tr><td><strong>Virus Name</strong></td><td style='color: #d32f2f;'><strong>").append(scanResult.getVirusName()).append("</strong></td></tr>");
        sb.append("<tr><td><strong>Scan Engine</strong></td><td>").append(scanResult.getScanEngine()).append("</td></tr>");
        sb.append("<tr><td><strong>Scan Duration</strong></td><td>").append(scanResult.getScanDurationMs()).append(" ms</td></tr>");
        sb.append("<tr><td><strong>Raw Response</strong></td><td><code>").append(scanResult.getRawResponse()).append("</code></td></tr>");
        sb.append("</table>");

        if (scanResult.getQuarantined() != null && scanResult.getQuarantined()) {
            sb.append("<h3 style='color: #388e3c;'>Action Taken</h3>");
            sb.append("<p>The infected file has been <strong>quarantined</strong>.</p>");
            sb.append("<p>Quarantine Path: <code>").append(scanResult.getQuarantinePath()).append("</code></p>");
        } else {
            sb.append("<h3 style='color: #f57c00;'>Action Required</h3>");
            sb.append("<p>Please review and take appropriate action for this infected file.</p>");
        }

        sb.append("<hr/>");
        sb.append("<p style='font-size: 12px; color: #666;'>Scan Time: ").append(java.time.Instant.ofEpochMilli(scanResult.getCreatedTime())).append("</p>");
        sb.append("<p style='font-size: 12px; color: #666;'>This is an automated alert from the DIGIT Malware Detection Service.</p>");
        sb.append("</body></html>");

        return sb.toString();
    }

    // ==================== EMAIL DIRECT (JavaMailSender) ====================

    private void sendEmailDirect(ScanResult scanResult) {
        String subject = String.format("[ALERT] %s - Malware Detected: %s",
                config.getMailAlertSubject(), scanResult.getVirusName());

        String body = buildPlainTextEmailBody(scanResult);

        SimpleMailMessage message = new SimpleMailMessage();
        message.setTo(config.getMailAlertRecipients().split(","));
        message.setSubject(subject);
        message.setText(body);

        mailSender.send(message);
    }

    private String buildPlainTextEmailBody(ScanResult scanResult) {
        StringBuilder sb = new StringBuilder();
        sb.append("MALWARE DETECTION ALERT\n");
        sb.append("========================\n\n");

        sb.append("File Information:\n");
        sb.append("-----------------\n");
        sb.append("FileStore ID: ").append(scanResult.getFileStoreId()).append("\n");
        sb.append("Tenant ID: ").append(scanResult.getTenantId()).append("\n");
        sb.append("File Name: ").append(scanResult.getFileName()).append("\n");
        sb.append("File Path: ").append(scanResult.getFilePath()).append("\n");
        sb.append("File Hash (SHA-256): ").append(scanResult.getFileHash()).append("\n");
        sb.append("File Size: ").append(formatFileSize(scanResult.getFileSize())).append("\n\n");

        sb.append("Scan Details:\n");
        sb.append("-------------\n");
        sb.append("Virus Name: ").append(scanResult.getVirusName()).append("\n");
        sb.append("Scan Engine: ").append(scanResult.getScanEngine()).append("\n");
        sb.append("Scan Duration: ").append(scanResult.getScanDurationMs()).append("ms\n");
        sb.append("Raw Response: ").append(scanResult.getRawResponse()).append("\n\n");

        if (scanResult.getQuarantined() != null && scanResult.getQuarantined()) {
            sb.append("Action Taken:\n");
            sb.append("-------------\n");
            sb.append("File has been quarantined.\n");
            sb.append("Quarantine Path: ").append(scanResult.getQuarantinePath()).append("\n\n");
        } else {
            sb.append("ACTION REQUIRED: Please review and take appropriate action.\n\n");
        }

        sb.append("Scan Time: ").append(java.time.Instant.ofEpochMilli(scanResult.getCreatedTime())).append("\n");
        sb.append("\n--\n");
        sb.append("This is an automated alert from the DIGIT Malware Detection Service.\n");

        return sb.toString();
    }

    // ==================== UTILITY ====================

    private String formatFileSize(Long size) {
        if (size == null) {
            return "Unknown";
        }
        if (size < 1024) {
            return size + " B";
        } else if (size < 1024 * 1024) {
            return String.format("%.2f KB", size / 1024.0);
        } else if (size < 1024 * 1024 * 1024) {
            return String.format("%.2f MB", size / (1024.0 * 1024));
        } else {
            return String.format("%.2f GB", size / (1024.0 * 1024 * 1024));
        }
    }

    public void sendCleanFileNotification(ScanResult scanResult) {
        // Optional: Send notification for clean files if needed
        log.debug("File is clean, no notification sent for fileStoreId: {}", scanResult.getFileStoreId());
    }
}
