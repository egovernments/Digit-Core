package org.egov.malware.service;

import lombok.extern.slf4j.Slf4j;
import org.egov.malware.model.AuditAction;
import org.egov.malware.model.ScanAudit;
import org.egov.malware.model.ScanResult;
import org.egov.malware.repository.ScanAuditRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * Service for managing malware scan audit logs.
 * Provides convenient methods for logging various scan actions.
 */
@Service
@Slf4j
public class ScanAuditService {

    private final ScanAuditRepository auditRepository;

    @Autowired
    public ScanAuditService(ScanAuditRepository auditRepository) {
        this.auditRepository = auditRepository;
    }

    // ==================== AUDIT LOGGING METHODS ====================

    /**
     * Logs an audit entry asynchronously to avoid blocking main operations.
     */
    @Async
    public void logAsync(ScanResult scanResult, AuditAction action, String details) {
        try {
            log(scanResult, action, details);
        } catch (Exception e) {
            log.error("Failed to log audit entry asynchronously for fileStoreId: {}, action: {}",
                    scanResult.getFileStoreId(), action, e);
        }
    }

    /**
     * Logs an audit entry synchronously.
     */
    public void log(ScanResult scanResult, AuditAction action, String details) {
        ScanAudit audit = ScanAudit.fromScanResult(scanResult, action, details);
        auditRepository.save(audit);
        log.info("[AUDIT] {} - fileStoreId: {}, details: {}",
                action.name(), scanResult.getFileStoreId(), details);
    }

    /**
     * Logs an audit entry with custom parameters.
     */
    public void log(String scanResultId, String fileStoreId, String tenantId,
                    AuditAction action, String details, String actionBy) {
        ScanAudit audit = ScanAudit.create(scanResultId, fileStoreId, tenantId, action, details, actionBy);
        auditRepository.save(audit);
        log.info("[AUDIT] {} - fileStoreId: {}, details: {}", action.name(), fileStoreId, details);
    }

    // ==================== SCAN LIFECYCLE AUDIT ====================

    public void logScanRequested(ScanResult scanResult) {
        log(scanResult, AuditAction.SCAN_REQUESTED,
                String.format("Scan requested for file: %s", scanResult.getFileName()));
    }

    public void logScanStarted(ScanResult scanResult) {
        log(scanResult, AuditAction.SCAN_STARTED,
                String.format("Scan started using engine: %s", scanResult.getScanEngine()));
    }

    public void logScanCompletedClean(ScanResult scanResult) {
        log(scanResult, AuditAction.SCAN_COMPLETED_CLEAN,
                String.format("File is clean. Scan duration: %dms", scanResult.getScanDurationMs()));
    }

    public void logScanCompletedInfected(ScanResult scanResult) {
        log(scanResult, AuditAction.SCAN_COMPLETED_INFECTED,
                String.format("Malware detected: %s. Scan duration: %dms",
                        scanResult.getVirusName(), scanResult.getScanDurationMs()));
    }

    public void logScanFailed(ScanResult scanResult, String errorMessage) {
        log(scanResult, AuditAction.SCAN_FAILED,
                String.format("Scan failed: %s", errorMessage));
    }

    public void logScanSkipped(ScanResult scanResult, String reason) {
        log(scanResult, AuditAction.SCAN_SKIPPED,
                String.format("Scan skipped: %s", reason));
    }

    // ==================== QUARANTINE AUDIT ====================

    public void logQuarantineStarted(ScanResult scanResult) {
        log(scanResult, AuditAction.QUARANTINE_STARTED,
                String.format("Quarantine initiated for infected file: %s", scanResult.getFileName()));
    }

    public void logQuarantineCompleted(ScanResult scanResult) {
        log(scanResult, AuditAction.QUARANTINE_COMPLETED,
                String.format("File quarantined to: %s", scanResult.getQuarantinePath()));
    }

    public void logQuarantineFailed(ScanResult scanResult, String errorMessage) {
        log(scanResult, AuditAction.QUARANTINE_FAILED,
                String.format("Quarantine failed: %s", errorMessage));
    }

    public void logOriginalDeleted(ScanResult scanResult) {
        log(scanResult, AuditAction.ORIGINAL_DELETED,
                String.format("Original infected file deleted from: %s", scanResult.getFilePath()));
    }

    // ==================== NOTIFICATION AUDIT ====================

    public void logSlackNotificationSent(ScanResult scanResult) {
        log(scanResult, AuditAction.NOTIFICATION_SLACK_SENT,
                "Slack notification sent successfully");
    }

    public void logSlackNotificationFailed(ScanResult scanResult, String errorMessage) {
        log(scanResult, AuditAction.NOTIFICATION_SLACK_FAILED,
                String.format("Slack notification failed: %s", errorMessage));
    }

    public void logEmailNotificationSent(ScanResult scanResult, String recipients) {
        log(scanResult, AuditAction.NOTIFICATION_EMAIL_SENT,
                String.format("Email notification sent to: %s", recipients));
    }

    public void logEmailNotificationFailed(ScanResult scanResult, String errorMessage) {
        log(scanResult, AuditAction.NOTIFICATION_EMAIL_FAILED,
                String.format("Email notification failed: %s", errorMessage));
    }

    // ==================== QUERY METHODS ====================

    /**
     * Gets complete audit trail for a scan result.
     */
    public List<ScanAudit> getAuditTrail(String scanResultId) {
        return auditRepository.findByScanResultId(scanResultId);
    }

    /**
     * Gets audit trail for a file by filestore ID.
     */
    public List<ScanAudit> getAuditTrailByFileStoreId(String fileStoreId, String tenantId) {
        return auditRepository.findByFileStoreId(fileStoreId, tenantId);
    }

    /**
     * Gets recent audit entries for a tenant.
     */
    public List<ScanAudit> getRecentAudits(String tenantId, int limit, int offset) {
        return auditRepository.findByTenant(tenantId, limit, offset);
    }

    /**
     * Gets audit entries by action type.
     */
    public List<ScanAudit> getAuditsByAction(AuditAction action, String tenantId, int limit) {
        return auditRepository.findByAction(action, tenantId, limit);
    }

    /**
     * Gets audit entries within a time range.
     */
    public List<ScanAudit> getAuditsByTimeRange(String tenantId, long startTime, long endTime) {
        return auditRepository.findByTimeRange(tenantId, startTime, endTime);
    }
}
