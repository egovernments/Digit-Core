package org.egov.malware.service;

import lombok.extern.slf4j.Slf4j;
import org.egov.malware.model.*;
import org.springframework.stereotype.Service;

import java.util.UUID;

@Service
@Slf4j
public class EnrichmentService {

    private static final String SCAN_ENGINE = "ClamAV";

    public ScanResult buildScanResult(FileInfo fileInfo, ClamAVResponse clamAVResponse) {
        log.debug("Building scan result for fileStoreId: {}", fileInfo.getFileStoreId());

        ScanStatus status;
        if (clamAVResponse.getErrorMessage() != null) {
            status = ScanStatus.ERROR;
        } else if (clamAVResponse.isClean()) {
            status = ScanStatus.CLEAN;
        } else {
            status = ScanStatus.INFECTED;
        }

        return ScanResult.builder()
                .fileStoreId(fileInfo.getFileStoreId())
                .tenantId(fileInfo.getTenantId())
                .fileName(fileInfo.getFileName())
                .filePath(fileInfo.getFilePath())
                .fileHash(fileInfo.getFileHash())
                .fileSize(fileInfo.getFileSize())
                .status(status)
                .virusName(clamAVResponse.getVirusName())
                .scanEngine(SCAN_ENGINE)
                .rawResponse(clamAVResponse.getRawResponse())
                .scanDurationMs(clamAVResponse.getScanDurationMs())
                .quarantined(false)
                .notificationSent(false)
                .build();
    }

    public ScanResult enrichScanResult(ScanResult scanResult, String createdBy) {
        log.debug("Enriching scan result for fileStoreId: {}", scanResult.getFileStoreId());

        long currentTime = System.currentTimeMillis();

        // Generate UUID
        scanResult.setId(UUID.randomUUID().toString());

        // Set audit details
        scanResult.setCreatedBy(createdBy != null ? createdBy : "SYSTEM");
        scanResult.setCreatedTime(currentTime);
        scanResult.setLastModifiedBy(createdBy != null ? createdBy : "SYSTEM");
        scanResult.setLastModifiedTime(currentTime);

        // Get ClamAV version if available
        scanResult.setScanEngineVersion(getClamAVVersion());

        log.info("Enriched scan result - id: {}, fileStoreId: {}, status: {}",
                scanResult.getId(), scanResult.getFileStoreId(), scanResult.getStatus());

        return scanResult;
    }

    public ScanResult updateQuarantineInfo(ScanResult scanResult, QuarantineResult quarantineResult) {
        if (quarantineResult.isSuccess()) {
            scanResult.setQuarantined(true);
            scanResult.setQuarantinePath(quarantineResult.getQuarantinePath());
            scanResult.setStatus(ScanStatus.QUARANTINED);
        }
        scanResult.setLastModifiedTime(System.currentTimeMillis());
        return scanResult;
    }

    public ScanResult updateNotificationInfo(ScanResult scanResult, NotificationResult notificationResult) {
        scanResult.setNotificationSent(notificationResult.isAnyNotificationSent());
        scanResult.setLastModifiedTime(System.currentTimeMillis());
        return scanResult;
    }

    private String getClamAVVersion() {
        // This could be fetched from ClamAVService if needed
        // For now, returning a placeholder
        return "1.0.0";
    }
}
