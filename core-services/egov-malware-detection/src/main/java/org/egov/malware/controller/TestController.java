package org.egov.malware.controller;

import lombok.extern.slf4j.Slf4j;
import org.egov.malware.config.MalwareDetectionConfig;
import org.egov.malware.model.*;
import org.egov.malware.service.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.nio.charset.StandardCharsets;
import java.util.HashMap;
import java.util.Map;

/**
 * Test Controller for development and debugging purposes.
 *
 * This controller provides endpoints to test individual components
 * of the malware detection service without going through the full
 * Kafka message flow.
 *
 * WARNING: These endpoints should be disabled or secured in production.
 */
@RestController
@RequestMapping("/malware-detection/v1/_test")
@Slf4j
public class TestController {

    private final ClamAVService clamAVService;
    private final FileRetrievalService fileRetrievalService;
    private final QuarantineService quarantineService;
    private final NotificationService notificationService;
    private final EnrichmentService enrichmentService;
    private final MalwareDetectionConfig config;

    @Autowired
    public TestController(ClamAVService clamAVService,
                          FileRetrievalService fileRetrievalService,
                          QuarantineService quarantineService,
                          NotificationService notificationService,
                          EnrichmentService enrichmentService,
                          MalwareDetectionConfig config) {
        this.clamAVService = clamAVService;
        this.fileRetrievalService = fileRetrievalService;
        this.quarantineService = quarantineService;
        this.notificationService = notificationService;
        this.enrichmentService = enrichmentService;
        this.config = config;
    }

    /**
     * Test ClamAV connectivity and get version info
     */
    @GetMapping("/clamav/ping")
    public ResponseEntity<Map<String, Object>> pingClamAV() {
        log.info("Testing ClamAV connectivity");

        Map<String, Object> response = new HashMap<>();
        response.put("timestamp", System.currentTimeMillis());

        try {
            boolean available = clamAVService.isAvailable();
            response.put("available", available);

            if (available) {
                String version = clamAVService.getVersion();
                response.put("version", version);
                response.put("status", "SUCCESS");
                response.put("host", config.getClamavHost());
                response.put("port", config.getClamavPort());
            } else {
                response.put("status", "UNAVAILABLE");
                response.put("message", "ClamAV daemon is not responding");
            }

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            log.error("ClamAV ping failed", e);
            response.put("status", "ERROR");
            response.put("error", e.getMessage());
            return ResponseEntity.status(HttpStatus.SERVICE_UNAVAILABLE).body(response);
        }
    }

    /**
     * Test ClamAV scanning with EICAR test string (standard antivirus test)
     * This will always be detected as malware - it's a safe test pattern.
     */
    @PostMapping("/clamav/scan-eicar")
    public ResponseEntity<Map<String, Object>> scanEicarTestString() {
        log.info("Testing ClamAV with EICAR test string");

        // Standard EICAR test string - detected by all antivirus as test malware
        String eicarTestString = "X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*";
        byte[] eicarBytes = eicarTestString.getBytes(StandardCharsets.UTF_8);

        Map<String, Object> response = new HashMap<>();
        response.put("timestamp", System.currentTimeMillis());
        response.put("testType", "EICAR");
        response.put("testDescription", "Standard antivirus test string - should be detected as malware");

        try {
            FileInfo testFileInfo = FileInfo.builder()
                    .fileStoreId("test-eicar-" + System.currentTimeMillis())
                    .tenantId("test")
                    .fileName("eicar-test.txt")
                    .filePath("test/eicar-test.txt")
                    .contentType("text/plain")
                    .fileSize((long) eicarBytes.length)
                    .fileSource("minio")
                    .content(eicarBytes)
                    .build();

            // Calculate hash
            testFileInfo.setFileHash(fileRetrievalService.calculateSHA256Hash(eicarBytes));

            ClamAVResponse clamResponse = clamAVService.scanFile(testFileInfo);

            response.put("scanResult", clamResponse.getStatus().name());
            response.put("virusName", clamResponse.getVirusName());
            response.put("rawResponse", clamResponse.getRawResponse());
            response.put("scanDurationMs", clamResponse.getScanDurationMs());
            response.put("fileHash", testFileInfo.getFileHash());

            if (clamResponse.getStatus() == ScanStatus.INFECTED) {
                response.put("status", "SUCCESS");
                response.put("message", "EICAR test successful - malware correctly detected");
            } else {
                response.put("status", "WARNING");
                response.put("message", "EICAR was NOT detected - ClamAV may not be functioning correctly");
            }

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            log.error("EICAR test failed", e);
            response.put("status", "ERROR");
            response.put("error", e.getMessage());
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
        }
    }

    /**
     * Test ClamAV scanning with clean content
     */
    @PostMapping("/clamav/scan-clean")
    public ResponseEntity<Map<String, Object>> scanCleanContent() {
        log.info("Testing ClamAV with clean content");

        String cleanContent = "This is a clean test file for malware scanning verification. " +
                "It contains no malicious content and should pass the scan successfully.";
        byte[] cleanBytes = cleanContent.getBytes(StandardCharsets.UTF_8);

        Map<String, Object> response = new HashMap<>();
        response.put("timestamp", System.currentTimeMillis());
        response.put("testType", "CLEAN");
        response.put("testDescription", "Clean content - should NOT be detected as malware");

        try {
            FileInfo testFileInfo = FileInfo.builder()
                    .fileStoreId("test-clean-" + System.currentTimeMillis())
                    .tenantId("test")
                    .fileName("clean-test.txt")
                    .filePath("test/clean-test.txt")
                    .contentType("text/plain")
                    .fileSize((long) cleanBytes.length)
                    .fileSource("minio")
                    .content(cleanBytes)
                    .build();

            testFileInfo.setFileHash(fileRetrievalService.calculateSHA256Hash(cleanBytes));

            ClamAVResponse clamResponse = clamAVService.scanFile(testFileInfo);

            response.put("scanResult", clamResponse.getStatus().name());
            response.put("rawResponse", clamResponse.getRawResponse());
            response.put("scanDurationMs", clamResponse.getScanDurationMs());
            response.put("fileHash", testFileInfo.getFileHash());

            if (clamResponse.getStatus() == ScanStatus.CLEAN) {
                response.put("status", "SUCCESS");
                response.put("message", "Clean content test successful - correctly identified as clean");
            } else {
                response.put("status", "WARNING");
                response.put("message", "Clean content was flagged - unexpected result");
                response.put("virusName", clamResponse.getVirusName());
            }

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            log.error("Clean content test failed", e);
            response.put("status", "ERROR");
            response.put("error", e.getMessage());
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
        }
    }

    /**
     * Test ClamAV scanning with custom content
     */
    @PostMapping("/clamav/scan-content")
    public ResponseEntity<Map<String, Object>> scanCustomContent(@RequestBody Map<String, String> request) {
        String content = request.get("content");
        String fileName = request.getOrDefault("fileName", "test-file.txt");

        log.info("Testing ClamAV with custom content, fileName: {}", fileName);

        Map<String, Object> response = new HashMap<>();
        response.put("timestamp", System.currentTimeMillis());
        response.put("testType", "CUSTOM");
        response.put("fileName", fileName);

        if (content == null || content.isEmpty()) {
            response.put("status", "ERROR");
            response.put("error", "Content is required");
            return ResponseEntity.badRequest().body(response);
        }

        byte[] contentBytes = content.getBytes(StandardCharsets.UTF_8);

        try {
            FileInfo testFileInfo = FileInfo.builder()
                    .fileStoreId("test-custom-" + System.currentTimeMillis())
                    .tenantId("test")
                    .fileName(fileName)
                    .filePath("test/" + fileName)
                    .contentType("text/plain")
                    .fileSize((long) contentBytes.length)
                    .fileSource("minio")
                    .content(contentBytes)
                    .build();

            testFileInfo.setFileHash(fileRetrievalService.calculateSHA256Hash(contentBytes));

            ClamAVResponse clamResponse = clamAVService.scanFile(testFileInfo);

            response.put("scanResult", clamResponse.getStatus().name());
            response.put("rawResponse", clamResponse.getRawResponse());
            response.put("scanDurationMs", clamResponse.getScanDurationMs());
            response.put("fileHash", testFileInfo.getFileHash());
            response.put("fileSize", contentBytes.length);

            if (clamResponse.getStatus() == ScanStatus.INFECTED) {
                response.put("virusName", clamResponse.getVirusName());
            }

            response.put("status", "SUCCESS");
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            log.error("Custom content scan failed", e);
            response.put("status", "ERROR");
            response.put("error", e.getMessage());
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
        }
    }

    /**
     * Test file retrieval from MinIO/S3
     */
    @PostMapping("/storage/fetch")
    public ResponseEntity<Map<String, Object>> testFileFetch(@RequestBody MalwareScanRequest request) {
        log.info("Testing file fetch for fileStoreId: {}", request.getFileStoreId());

        Map<String, Object> response = new HashMap<>();
        response.put("timestamp", System.currentTimeMillis());
        response.put("fileStoreId", request.getFileStoreId());
        response.put("tenantId", request.getTenantId());

        try {
            FileInfo fileInfo = fileRetrievalService.fetchFile(request);

            response.put("status", "SUCCESS");
            response.put("fileName", fileInfo.getFileName());
            response.put("filePath", fileInfo.getFilePath());
            response.put("fileSize", fileInfo.getFileSize());
            response.put("contentType", fileInfo.getContentType());
            response.put("fileHash", fileInfo.getFileHash());
            response.put("fileSource", fileInfo.getFileSource());
            response.put("message", "File fetched successfully");

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            log.error("File fetch test failed", e);
            response.put("status", "ERROR");
            response.put("error", e.getMessage());
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
        }
    }

    /**
     * Test notification sending (Slack and Email)
     */
    @PostMapping("/notification/test")
    public ResponseEntity<Map<String, Object>> testNotification(@RequestBody Map<String, String> request) {
        log.info("Testing notification service");

        String virusName = request.getOrDefault("virusName", "Test-Virus-EICAR");
        String fileStoreId = request.getOrDefault("fileStoreId", "test-file-123");
        String tenantId = request.getOrDefault("tenantId", "pb");

        Map<String, Object> response = new HashMap<>();
        response.put("timestamp", System.currentTimeMillis());

        try {
            // Build a test scan result
            ScanResult testScanResult = ScanResult.builder()
                    .id("test-notification-" + System.currentTimeMillis())
                    .fileStoreId(fileStoreId)
                    .tenantId(tenantId)
                    .fileName("test-infected-file.exe")
                    .filePath(tenantId + "/test/test-infected-file.exe")
                    .fileHash("abc123def456...")
                    .fileSize(1024L)
                    .status(ScanStatus.INFECTED)
                    .virusName(virusName)
                    .scanEngine("ClamAV")
                    .scanDurationMs(150L)
                    .quarantined(true)
                    .quarantinePath(tenantId + "/quarantine/test-infected-file.exe")
                    .createdTime(System.currentTimeMillis())
                    .build();

            NotificationResult notificationResult = notificationService.sendInfectedFileAlert(testScanResult);

            response.put("status", "SUCCESS");
            response.put("slackSent", notificationResult.isSlackSent());
            response.put("emailSent", notificationResult.isEmailSent());
            response.put("slackError", notificationResult.getSlackError());
            response.put("emailError", notificationResult.getEmailError());
            response.put("message", "Notification test completed");

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            log.error("Notification test failed", e);
            response.put("status", "ERROR");
            response.put("error", e.getMessage());
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
        }
    }

    /**
     * Get current configuration (sanitized - no secrets)
     */
    @GetMapping("/config")
    public ResponseEntity<Map<String, Object>> getConfig() {
        log.info("Getting sanitized configuration");

        Map<String, Object> response = new HashMap<>();
        response.put("timestamp", System.currentTimeMillis());

        // ClamAV config
        Map<String, Object> clamav = new HashMap<>();
        clamav.put("host", config.getClamavHost());
        clamav.put("port", config.getClamavPort());
        clamav.put("timeout", config.getClamavTimeout());
        clamav.put("chunkSize", config.getClamavChunkSize());
        response.put("clamav", clamav);

        // MinIO config (sanitized)
        Map<String, Object> minio = new HashMap<>();
        minio.put("url", config.getMinioUrl());
        minio.put("bucketName", config.getMinioBucketName());
        minio.put("bucketRegion", config.getMinioBucketRegion());
        minio.put("quarantineBucket", config.getQuarantineBucketName());
        response.put("minio", minio);

        // Notification config
        Map<String, Object> notification = new HashMap<>();
        notification.put("slackEnabled", config.isSlackEnabled());
        notification.put("slackChannel", config.getSlackChannel());
        notification.put("emailEnabled", config.isMailEnabled());
        notification.put("emailMode", config.getMailNotificationMode());
        notification.put("emailRecipients", config.getMailAlertRecipients());
        response.put("notification", notification);

        // Scan settings
        Map<String, Object> scan = new HashMap<>();
        scan.put("maxFileSizeMb", config.getMaxFileSizeMb());
        scan.put("quarantineEnabled", config.isQuarantineEnabled());
        scan.put("deleteOriginalOnQuarantine", config.isDeleteOriginalOnQuarantine());
        response.put("scan", scan);

        return ResponseEntity.ok(response);
    }

    /**
     * Full end-to-end test: Fetch file from storage and scan it
     */
    @PostMapping("/e2e/scan")
    public ResponseEntity<Map<String, Object>> endToEndScan(@RequestBody MalwareScanRequest request) {
        log.info("Running end-to-end scan test for fileStoreId: {}", request.getFileStoreId());

        Map<String, Object> response = new HashMap<>();
        response.put("timestamp", System.currentTimeMillis());
        response.put("fileStoreId", request.getFileStoreId());
        response.put("tenantId", request.getTenantId());

        try {
            // Step 1: Fetch file
            log.info("E2E Step 1: Fetching file from storage");
            long fetchStart = System.currentTimeMillis();
            FileInfo fileInfo = fileRetrievalService.fetchFile(request);
            long fetchDuration = System.currentTimeMillis() - fetchStart;

            response.put("fetchDurationMs", fetchDuration);
            response.put("fileName", fileInfo.getFileName());
            response.put("fileSize", fileInfo.getFileSize());
            response.put("fileHash", fileInfo.getFileHash());

            // Step 2: Scan file
            log.info("E2E Step 2: Scanning file with ClamAV");
            ClamAVResponse clamResponse = clamAVService.scanFile(fileInfo);

            response.put("scanResult", clamResponse.getStatus().name());
            response.put("scanDurationMs", clamResponse.getScanDurationMs());
            response.put("rawResponse", clamResponse.getRawResponse());

            if (clamResponse.getStatus() == ScanStatus.INFECTED) {
                response.put("virusName", clamResponse.getVirusName());
            }

            // Step 3: Build result
            log.info("E2E Step 3: Building scan result");
            ScanResult scanResult = enrichmentService.buildScanResult(fileInfo, clamResponse);
            scanResult = enrichmentService.enrichScanResult(scanResult, request.getUploadedBy());

            response.put("scanResultId", scanResult.getId());
            response.put("status", "SUCCESS");
            response.put("totalDurationMs", fetchDuration + clamResponse.getScanDurationMs());

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            log.error("E2E scan test failed", e);
            response.put("status", "ERROR");
            response.put("error", e.getMessage());
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
        }
    }
}
