package org.egov.malware.repository;

import lombok.extern.slf4j.Slf4j;
import org.egov.malware.model.ScanResult;
import org.egov.malware.model.ScanStatus;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.List;
import java.util.Optional;

@Repository
@Slf4j
public class ScanResultRepository {

    private final JdbcTemplate jdbcTemplate;

    private static final String INSERT_QUERY = """
            INSERT INTO eg_malware_scan_results (
                id, filestore_id, tenant_id, file_name, file_path, file_hash, file_size,
                status, virus_name, scan_engine, scan_engine_version, scan_duration_ms,
                raw_response, quarantined, quarantine_path, notification_sent,
                created_by, created_time, last_modified_by, last_modified_time
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ON CONFLICT (filestore_id, tenant_id) DO UPDATE SET
                status = EXCLUDED.status,
                virus_name = EXCLUDED.virus_name,
                scan_duration_ms = EXCLUDED.scan_duration_ms,
                raw_response = EXCLUDED.raw_response,
                quarantined = EXCLUDED.quarantined,
                quarantine_path = EXCLUDED.quarantine_path,
                notification_sent = EXCLUDED.notification_sent,
                last_modified_by = EXCLUDED.last_modified_by,
                last_modified_time = EXCLUDED.last_modified_time
            """;

    private static final String SELECT_BY_FILESTORE_ID = """
            SELECT * FROM eg_malware_scan_results
            WHERE filestore_id = ? AND tenant_id = ?
            """;

    private static final String SELECT_BY_STATUS = """
            SELECT * FROM eg_malware_scan_results
            WHERE status = ? AND tenant_id = ?
            ORDER BY created_time DESC
            LIMIT ?
            """;

    private static final String SELECT_BY_TENANT = """
            SELECT * FROM eg_malware_scan_results
            WHERE tenant_id = ?
            ORDER BY created_time DESC
            LIMIT ? OFFSET ?
            """;

    @Autowired
    public ScanResultRepository(JdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }

    public void save(ScanResult scanResult) {
        log.debug("Saving scan result for fileStoreId: {}", scanResult.getFileStoreId());

        jdbcTemplate.update(INSERT_QUERY,
                scanResult.getId(),
                scanResult.getFileStoreId(),
                scanResult.getTenantId(),
                scanResult.getFileName(),
                scanResult.getFilePath(),
                scanResult.getFileHash(),
                scanResult.getFileSize(),
                scanResult.getStatus().name(),
                scanResult.getVirusName(),
                scanResult.getScanEngine(),
                scanResult.getScanEngineVersion(),
                scanResult.getScanDurationMs(),
                scanResult.getRawResponse(),
                scanResult.getQuarantined(),
                scanResult.getQuarantinePath(),
                scanResult.getNotificationSent(),
                scanResult.getCreatedBy(),
                scanResult.getCreatedTime(),
                scanResult.getLastModifiedBy(),
                scanResult.getLastModifiedTime()
        );

        log.info("Scan result saved successfully for fileStoreId: {}", scanResult.getFileStoreId());
    }

    public Optional<ScanResult> findByFileStoreId(String fileStoreId, String tenantId) {
        log.debug("Finding scan result for fileStoreId: {}, tenantId: {}", fileStoreId, tenantId);

        List<ScanResult> results = jdbcTemplate.query(SELECT_BY_FILESTORE_ID,
                new ScanResultRowMapper(), fileStoreId, tenantId);

        return results.isEmpty() ? Optional.empty() : Optional.of(results.get(0));
    }

    public List<ScanResult> findByStatus(ScanStatus status, String tenantId, int limit) {
        log.debug("Finding scan results by status: {}, tenantId: {}", status, tenantId);

        return jdbcTemplate.query(SELECT_BY_STATUS,
                new ScanResultRowMapper(), status.name(), tenantId, limit);
    }

    public List<ScanResult> findByTenant(String tenantId, int limit, int offset) {
        log.debug("Finding scan results for tenantId: {}", tenantId);

        return jdbcTemplate.query(SELECT_BY_TENANT,
                new ScanResultRowMapper(), tenantId, limit, offset);
    }

    private static class ScanResultRowMapper implements RowMapper<ScanResult> {
        @Override
        public ScanResult mapRow(ResultSet rs, int rowNum) throws SQLException {
            return ScanResult.builder()
                    .id(rs.getString("id"))
                    .fileStoreId(rs.getString("filestore_id"))
                    .tenantId(rs.getString("tenant_id"))
                    .fileName(rs.getString("file_name"))
                    .filePath(rs.getString("file_path"))
                    .fileHash(rs.getString("file_hash"))
                    .fileSize(rs.getLong("file_size"))
                    .status(ScanStatus.valueOf(rs.getString("status")))
                    .virusName(rs.getString("virus_name"))
                    .scanEngine(rs.getString("scan_engine"))
                    .scanEngineVersion(rs.getString("scan_engine_version"))
                    .scanDurationMs(rs.getLong("scan_duration_ms"))
                    .rawResponse(rs.getString("raw_response"))
                    .quarantined(rs.getBoolean("quarantined"))
                    .quarantinePath(rs.getString("quarantine_path"))
                    .notificationSent(rs.getBoolean("notification_sent"))
                    .createdBy(rs.getString("created_by"))
                    .createdTime(rs.getLong("created_time"))
                    .lastModifiedBy(rs.getString("last_modified_by"))
                    .lastModifiedTime(rs.getLong("last_modified_time"))
                    .build();
        }
    }
}
