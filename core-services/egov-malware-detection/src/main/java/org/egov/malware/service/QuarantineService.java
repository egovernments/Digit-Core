package org.egov.malware.service;

import io.minio.*;
import lombok.extern.slf4j.Slf4j;
import org.egov.malware.config.MalwareDetectionConfig;
import org.egov.malware.model.FileInfo;
import org.egov.malware.model.QuarantineResult;
import org.egov.tracer.model.CustomException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.io.ByteArrayInputStream;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

@Service
@Slf4j
public class QuarantineService {

    private final MinioClient minioClient;
    private final MalwareDetectionConfig config;

    @Autowired
    public QuarantineService(MinioClient minioClient, MalwareDetectionConfig config) {
        this.minioClient = minioClient;
        this.config = config;
    }

    public QuarantineResult quarantineFile(FileInfo fileInfo, String virusName) {
        if (!config.isQuarantineEnabled()) {
            log.info("Quarantine is disabled, skipping quarantine for fileStoreId: {}",
                    fileInfo.getFileStoreId());
            return QuarantineResult.builder()
                    .success(false)
                    .originalPath(fileInfo.getFilePath())
                    .errorMessage("Quarantine is disabled")
                    .build();
        }

        log.info("Quarantining infected file - fileStoreId: {}, virusName: {}",
                fileInfo.getFileStoreId(), virusName);

        String originalPath = fileInfo.getFilePath();
        String quarantinePath = buildQuarantinePath(fileInfo);

        try {
            // Step 1: Ensure quarantine bucket exists
            ensureQuarantineBucketExists();

            // Step 2: Copy file to quarantine bucket
            copyToQuarantine(fileInfo, quarantinePath);
            log.info("File copied to quarantine - quarantinePath: {}", quarantinePath);

            // Step 3: Delete original file if configured
            boolean originalDeleted = false;
            if (config.isDeleteOriginalOnQuarantine()) {
                deleteOriginalFile(fileInfo);
                originalDeleted = true;
                log.info("Original file deleted - originalPath: {}", originalPath);
            }

            return QuarantineResult.success(originalPath, quarantinePath, originalDeleted);

        } catch (Exception e) {
            log.error("Failed to quarantine file - fileStoreId: {}, error: {}",
                    fileInfo.getFileStoreId(), e.getMessage(), e);
            return QuarantineResult.failure(originalPath,
                    "Failed to quarantine file: " + e.getMessage());
        }
    }

    private String buildQuarantinePath(FileInfo fileInfo) {
        // Format: tenantId/YYYY/MM/DD/fileStoreId_originalFileName
        LocalDateTime now = LocalDateTime.now();
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy/MM/dd");
        String datePath = now.format(formatter);

        String originalFileName = fileInfo.getFileName();
        if (originalFileName == null || originalFileName.isEmpty()) {
            originalFileName = fileInfo.getFileStoreId();
        }

        return String.format("%s/%s/%s_%s",
                fileInfo.getTenantId(),
                datePath,
                fileInfo.getFileStoreId(),
                originalFileName);
    }

    private void ensureQuarantineBucketExists() throws Exception {
        String quarantineBucket = config.getQuarantineBucketName();

        boolean bucketExists = minioClient.bucketExists(
                BucketExistsArgs.builder()
                        .bucket(quarantineBucket)
                        .build()
        );

        if (!bucketExists) {
            log.info("Creating quarantine bucket: {}", quarantineBucket);
            minioClient.makeBucket(
                    MakeBucketArgs.builder()
                            .bucket(quarantineBucket)
                            .build()
            );
        }
    }

    private void copyToQuarantine(FileInfo fileInfo, String quarantinePath) throws Exception {
        byte[] content = fileInfo.getContent();

        if (content == null || content.length == 0) {
            throw new CustomException("QUARANTINE_ERROR", "File content is empty");
        }

        ByteArrayInputStream inputStream = new ByteArrayInputStream(content);

        minioClient.putObject(
                PutObjectArgs.builder()
                        .bucket(config.getQuarantineBucketName())
                        .object(quarantinePath)
                        .stream(inputStream, content.length, -1)
                        .contentType(fileInfo.getContentType())
                        .build()
        );
    }

    private void deleteOriginalFile(FileInfo fileInfo) throws Exception {
        minioClient.removeObject(
                RemoveObjectArgs.builder()
                        .bucket(config.getMinioBucketName())
                        .object(fileInfo.getFilePath())
                        .build()
        );
    }

    public boolean isQuarantined(String fileStoreId, String quarantinePath) {
        try {
            minioClient.statObject(
                    StatObjectArgs.builder()
                            .bucket(config.getQuarantineBucketName())
                            .object(quarantinePath)
                            .build()
            );
            return true;
        } catch (Exception e) {
            return false;
        }
    }
}
