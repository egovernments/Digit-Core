# egov-malware-detection

Malware Detection Service for DIGIT Platform. This service automatically scans uploaded files for malware using ClamAV and handles quarantine and notifications for infected files.

## Table of Contents

- [Overview](#overview)
- [Architecture](#architecture)
- [Flow Diagram](#flow-diagram)
- [Components](#components)
- [Configuration](#configuration)
- [Email Notification Modes](#email-notification-modes)
- [Slack Integration](#slack-integration)
- [ClamAV Integration](#clamav-integration)
- [Database Schema](#database-schema)
- [API Endpoints](#api-endpoints)
- [Kafka Topics](#kafka-topics)
- [Deployment](#deployment)
- [Testing](#testing)
- [Troubleshooting](#troubleshooting)

---

## Overview

The egov-malware-detection service provides automated malware scanning for files uploaded to the DIGIT platform. It integrates with:

- **egov-filestore**: Receives file upload events via Kafka
- **ClamAV**: Open-source antivirus engine for malware scanning
- **egov-notification-mail**: Sends email alerts for infected files (optional)
- **Slack**: Sends webhook notifications for infected files
- **MinIO/S3**: Fetches files for scanning and quarantines infected files

### Key Features

| Feature | Description |
|---------|-------------|
| Automatic Scanning | Scans every file uploaded to filestore automatically |
| ClamAV Integration | Uses ClamAV daemon via TCP INSTREAM protocol |
| SHA-256 Hashing | Calculates file hash for audit and deduplication |
| Quarantine | Moves infected files to separate quarantine bucket |
| Slack Alerts | Sends detailed alerts to Slack channel |
| Email Alerts | Configurable: direct SMTP or via egov-notification-mail |
| Audit Logging | Persists all scan results to database |
| REST API | Manual scan trigger and scan result queries |

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              DIGIT Platform                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌──────────────┐         ┌─────────────────────────┐   ┌───────────────────────┐ │
│  │              │         │                         │   │                       │ │
│  │ egov-filestore│───────►│      Kafka Topic        │──►│ egov-malware-detection│ │
│  │   (upload)   │  Event  │ egov.malware.file-scan- │   │       Service         │ │
│  │              │         │        request          │   │                       │ │
│  └──────────────┘         └─────────────────────────┘   └───────────┬───────────┘ │
│                                                                   │             │
│         ┌─────────────────────────────────────────────────────────┼─────┐       │
│         │                                                         │     │       │
│         ▼                                                         ▼     │       │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌───────────┐ │       │
│  │   MinIO/S3  │    │   ClamAV    │    │ PostgreSQL  │    │   Kafka   │ │       │
│  │  (storage)  │    │  (scanner)  │    │  (audit)    │    │ (persist) │ │       │
│  └──────┬──────┘    └─────────────┘    └─────────────┘    └───────────┘ │       │
│         │                                                               │       │
│         │ If INFECTED                                                   │       │
│         ▼                                                               │       │
│  ┌─────────────┐    ┌─────────────────────────────────────────────────┐ │       │
│  │ Quarantine  │    │              Notifications                      │ │       │
│  │   Bucket    │    │  ┌─────────┐    ┌───────────────────────────┐  │ │       │
│  └─────────────┘    │  │  Slack  │    │ Email (direct or Kafka)   │  │ │       │
│                     │  │ Webhook │    │                           │  │ │       │
│                     │  └─────────┘    └───────────────────────────┘  │ │       │
│                     └─────────────────────────────────────────────────┘ │       │
│                                                                         │       │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## Flow Diagram

The service follows this flow when processing a file upload event:

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           MALWARE SCAN FLOW                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  1. RECEIVE EVENT                                                                │
│     └── MalwareScanRequestConsumer listens to Kafka topic                       │
│         (egov.malware.file-scan-request)                                        │
│                                                                                  │
│  2. VALIDATE REQUEST                                                             │
│     ├── ScanRequestValidator: Tenant ID, FileStore ID                           │
│     ├── FileExistsValidator: File content exists                                │
│     └── FileSizeValidator: File size within limits                              │
│                                                                                  │
│  3. FETCH FILE                                                                   │
│     └── FileRetrievalService                                                     │
│         ├── Download from MinIO/S3                                              │
│         ├── Calculate SHA-256 hash                                              │
│         └── Return FileInfo with content                                        │
│                                                                                  │
│  4. SCAN FILE                                                                    │
│     └── ClamAVService                                                            │
│         ├── TCP connection to ClamAV (port 3310)                                │
│         ├── Send INSTREAM command                                               │
│         ├── Stream file in chunks (2KB default)                                 │
│         ├── Send EOF marker                                                     │
│         └── Parse response (OK / FOUND / ERROR)                                 │
│                                                                                  │
│  5. BUILD RESULT                                                                 │
│     └── EnrichmentService                                                        │
│         ├── Create ScanResult with status                                       │
│         ├── Generate UUID                                                       │
│         └── Set audit details (createdBy, createdTime)                          │
│                                                                                  │
│  6. HANDLE INFECTED FILE (if status = INFECTED)                                 │
│     ├── QuarantineService                                                        │
│     │   ├── Copy file to quarantine bucket                                      │
│     │   └── Delete original (if configured)                                     │
│     └── NotificationService                                                      │
│         ├── Send Slack webhook notification                                     │
│         └── Send Email (direct SMTP or via Kafka)                               │
│                                                                                  │
│  7. PERSIST RESULT                                                               │
│     └── ScanResultProducer                                                       │
│         └── Publish to Kafka for async database persistence                     │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## Components

### Core Services

| Component | File | Description |
|-----------|------|-------------|
| **ScanService** | `service/ScanService.java` | Main orchestrator - coordinates the entire scan flow |
| **FileRetrievalService** | `service/FileRetrievalService.java` | Fetches files from MinIO/S3, calculates SHA-256 hash |
| **ClamAVService** | `service/ClamAVService.java` | TCP client for ClamAV daemon using INSTREAM protocol |
| **EnrichmentService** | `service/EnrichmentService.java` | Builds and enriches scan results with UUID and audit details |
| **QuarantineService** | `service/QuarantineService.java` | Moves infected files to quarantine bucket |
| **NotificationService** | `service/NotificationService.java` | Sends Slack and Email notifications |

### Kafka Components

| Component | File | Description |
|-----------|------|-------------|
| **MalwareScanRequestConsumer** | `consumer/MalwareScanRequestConsumer.java` | Listens to malware scan requests from filestore |
| **ScanResultPersisterConsumer** | `consumer/ScanResultPersisterConsumer.java` | Persists scan results to database |
| **ScanResultProducer** | `producer/ScanResultProducer.java` | Publishes scan results for async persistence |

### Validators

| Component | File | Description |
|-----------|------|-------------|
| **ScanRequestValidator** | `validator/ScanRequestValidator.java` | Validates tenant ID, filestore ID |
| **FileSizeValidator** | `validator/FileSizeValidator.java` | Validates file size against max limit |
| **FileExistsValidator** | `validator/FileExistsValidator.java` | Validates file content exists |

### Controllers

| Component | File | Description |
|-----------|------|-------------|
| **HealthController** | `controller/HealthController.java` | Health, readiness, version endpoints |
| **ScanController** | `controller/ScanController.java` | Manual scan API, scan result queries |

---

## Configuration

### application.properties

```properties
# =============================================================================
# SERVER CONFIGURATION
# =============================================================================
server.contextPath=/malware-detection
server.port=8087

# =============================================================================
# CLAMAV CONFIGURATION
# =============================================================================
# ClamAV daemon host (Kubernetes service name)
clamav.host=clamav.security.svc.cluster.local

# ClamAV daemon port (default: 3310)
clamav.port=3310

# Connection timeout in milliseconds
clamav.timeout=60000

# Chunk size for streaming files (bytes)
clamav.chunk.size=2048

# =============================================================================
# MINIO/S3 CONFIGURATION
# =============================================================================
minio.enabled=true
minio.url=https://s3.amazonaws.com
minio.access.key=${AWS_ACCESS_KEY}
minio.secret.key=${AWS_SECRET_KEY}
minio.bucket.name=egov-rainmaker-1
minio.bucket.region=ap-south-1

# Quarantine bucket for infected files
minio.quarantine.bucket.name=egov-quarantine

# =============================================================================
# KAFKA CONFIGURATION
# =============================================================================
spring.kafka.bootstrap-servers=localhost:9092
spring.kafka.consumer.group-id=malware-detection-group

# =============================================================================
# KAFKA TOPICS - MALWARE DETECTION
# =============================================================================
# All malware-related topics follow the naming convention: egov.malware.<action>

# Scan Request Topic (INPUT)
# - Published by: egov-filestore (after file upload)
# - Consumed by: egov-malware-detection (triggers scan workflow)
kafka.topics.malware.scan.request=egov.malware.file-scan-request

# Scan Result Topic (OUTPUT)
# - Published by: egov-malware-detection (after scan completes)
# - Consumed by: Any service needing real-time scan results
kafka.topics.malware.scan.result=egov.malware.scan-completed

# Scan Result Persistence Topic (INTERNAL)
# - Published by: egov-malware-detection (after enrichment)
# - Consumed by: egov-malware-detection persister consumer
kafka.topics.malware.scan.save=egov.malware.persist-scan-result

# Email Notification Topic (for Kafka mode)
kafka.topics.notification.email=egov.core.notification.email

# =============================================================================
# SLACK CONFIGURATION
# =============================================================================
slack.webhook.enabled=true
slack.webhook.url=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
slack.channel=#security-alerts
slack.username=MalwareBot
slack.icon.emoji=:warning:

# =============================================================================
# EMAIL CONFIGURATION
# =============================================================================
mail.enabled=true

# Email mode: "direct" (JavaMailSender) or "kafka" (egov-notification-mail)
mail.notification.mode=kafka

# SMTP settings (for direct mode)
mail.host=smtp.gmail.com
mail.port=465
mail.protocol=smtps
mail.sender.username=your-email@example.com
mail.sender.password=your-password

# Alert recipients
mail.alert.recipients=security@example.com,admin@example.com
mail.alert.subject=DIGIT Security Alert

# =============================================================================
# SCAN SETTINGS
# =============================================================================
# Maximum file size to scan (MB)
scan.max.file.size.mb=50

# =============================================================================
# QUARANTINE SETTINGS
# =============================================================================
quarantine.enabled=true
quarantine.delete.original=true
```

---

## Email Notification Modes

The service supports two email notification modes, configurable via `mail.notification.mode`:

### Mode 1: `kafka` (Recommended)

Sends emails via the existing `egov-notification-mail` service through Kafka.

```properties
mail.notification.mode=kafka
kafka.topics.notification.email=egov.core.notification.email
```

**Flow:**
```
Malware Service ──► Kafka Topic ──► egov-notification-mail ──► SMTP Server
                    (egov.core.notification.email)
```

**Advantages:**
- Reuses existing DIGIT infrastructure
- Centralized SMTP configuration
- Consistent with platform architecture
- Supports HTML formatted emails
- No additional SMTP configuration needed in malware service

**Email Format:** HTML with formatted tables showing file info, scan details, and actions taken.

---

### Mode 2: `direct`

Sends emails directly using JavaMailSender (standalone mode).

```properties
mail.notification.mode=direct
mail.host=smtp.gmail.com
mail.port=465
mail.protocol=smtps
mail.sender.username=your-email@example.com
mail.sender.password=your-password
```

**Flow:**
```
Malware Service ──► JavaMailSender ──► SMTP Server (direct)
```

**Advantages:**
- Self-contained, no dependency on other services
- Useful for local development and testing
- Works without egov-notification-mail deployment

**Email Format:** Plain text with structured information.

---

### Configuration Comparison

| Property | Kafka Mode | Direct Mode |
|----------|------------|-------------|
| `mail.notification.mode` | `kafka` | `direct` |
| SMTP Config Required | No (uses egov-notification-mail) | Yes |
| Email Format | HTML | Plain Text |
| Dependency | egov-notification-mail | None |
| Recommended For | Production | Development/Testing |

---

## Slack Integration

### Webhook Setup

1. Create an Incoming Webhook in Slack workspace
2. Configure the webhook URL in properties:

```properties
slack.webhook.enabled=true
slack.webhook.url=https://hooks.slack.com/services/T109J61DY/B0A2JS10P1B/YOUR_WEBHOOK_KEY
slack.channel=#security-alerts
slack.username=MalwareBot
slack.icon.emoji=:warning:
```

### Message Format

The Slack notification includes:

```
*MALWARE DETECTED*

*File Information:*
- FileStore ID: `abc123-def456`
- Tenant ID: `pb`
- File Name: `suspicious_file.exe`
- File Path: `pb/module/2024/12/19/file.exe`
- File Hash (SHA-256): `a1b2c3d4...`
- File Size: 1.25 MB

*Scan Details:*
- Virus Name: `Win.Trojan.Generic-12345`
- Scan Engine: ClamAV
- Scan Duration: 150ms

*Action Taken:* File has been quarantined
- Quarantine Path: `pb/2024/12/19/abc123_file.exe`

_Scan Time: 2024-12-19T10:30:00Z_
```

### Webhook Payload Format

Uses URL-encoded payload as per Slack API:

```bash
curl -X POST \
  --data-urlencode "payload={\"channel\":\"#security-alerts\",\"username\":\"MalwareBot\",\"text\":\"...\",\"icon_emoji\":\":warning:\"}" \
  https://hooks.slack.com/services/YOUR/WEBHOOK/URL
```

---

## ClamAV Integration

### Protocol: INSTREAM

The service uses ClamAV's INSTREAM protocol over TCP:

```
┌─────────────────┐                    ┌─────────────────┐
│  Malware        │                    │    ClamAV       │
│  Service        │                    │    Daemon       │
└────────┬────────┘                    └────────┬────────┘
         │                                      │
         │  1. TCP Connect (port 3310)          │
         │─────────────────────────────────────►│
         │                                      │
         │  2. Send: "zINSTREAM\0"              │
         │─────────────────────────────────────►│
         │                                      │
         │  3. Send: [4-byte size][chunk data]  │
         │─────────────────────────────────────►│
         │      ... repeat for all chunks ...   │
         │                                      │
         │  4. Send: [4 zero bytes] (EOF)       │
         │─────────────────────────────────────►│
         │                                      │
         │  5. Response: "stream: OK\n"         │
         │◄─────────────────────────────────────│
         │     or "stream: VirusName FOUND\n"   │
         │                                      │
```

### Response Parsing

| Response | Status | Action |
|----------|--------|--------|
| `stream: OK` | CLEAN | Log success, no further action |
| `stream: VirusName FOUND` | INFECTED | Quarantine + Notify |
| `stream: ERROR message` | ERROR | Log error, retry if needed |

### ClamAV Deployment

Deploy ClamAV in Kubernetes using Helm:

```bash
helm repo add wiremind https://wiremind.github.io/wiremind-helm-charts
helm install clamav wiremind/clamav -n security
```

Verify connectivity:
```bash
kubectl run -it --rm debug --image=busybox -n egov -- nc clamav.security.svc.cluster.local 3310
```

---

## Database Schema

### Table: eg_malware_scan_results

```sql
CREATE TABLE eg_malware_scan_results (
    id                   VARCHAR(64) PRIMARY KEY,
    filestore_id         VARCHAR(64) NOT NULL,
    tenant_id            VARCHAR(256) NOT NULL,
    file_name            VARCHAR(512),
    file_path            VARCHAR(1024),
    file_hash            VARCHAR(64),          -- SHA-256 hash
    file_size            BIGINT,
    status               VARCHAR(32) NOT NULL, -- CLEAN, INFECTED, ERROR, QUARANTINED
    virus_name           VARCHAR(256),
    scan_engine          VARCHAR(64),          -- ClamAV
    scan_engine_version  VARCHAR(32),
    scan_duration_ms     BIGINT,
    raw_response         TEXT,
    quarantined          BOOLEAN DEFAULT FALSE,
    quarantine_path      VARCHAR(1024),
    notification_sent    BOOLEAN DEFAULT FALSE,
    created_by           VARCHAR(64),
    created_time         BIGINT,
    last_modified_by     VARCHAR(64),
    last_modified_time   BIGINT,

    UNIQUE (filestore_id, tenant_id)
);
```

### Table: eg_malware_scan_audit

```sql
CREATE TABLE eg_malware_scan_audit (
    id              SERIAL PRIMARY KEY,
    scan_result_id  VARCHAR(64) NOT NULL,
    filestore_id    VARCHAR(64) NOT NULL,
    tenant_id       VARCHAR(256) NOT NULL,
    action          VARCHAR(64) NOT NULL,
    action_details  TEXT,
    action_time     BIGINT NOT NULL,
    action_by       VARCHAR(64)
);
```

---

## API Endpoints

### Health Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/malware-detection/health` | Service health status |
| GET | `/malware-detection/ready` | Readiness check (ClamAV connectivity) |
| GET | `/malware-detection/version` | Service and ClamAV version |

### Scan Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/malware-detection/v1/scan` | Manual scan trigger |
| GET | `/malware-detection/v1/result` | Get scan result by fileStoreId |
| GET | `/malware-detection/v1/results` | Get scan results by tenant |
| GET | `/malware-detection/v1/results/status/{status}` | Get results by status |
| GET | `/malware-detection/v1/stats` | Get scan statistics |

### Example: Manual Scan

```bash
curl -X POST http://localhost:8087/malware-detection/v1/scan \
  -H "Content-Type: application/json" \
  -d '{
    "fileStoreId": "abc123-def456",
    "tenantId": "pb",
    "fileName": "document.pdf",
    "filePath": "pb/module/2024/12/19/document.pdf"
  }'
```

### Example: Get Scan Result

```bash
curl "http://localhost:8087/malware-detection/v1/result?fileStoreId=abc123&tenantId=pb"
```

---

## Kafka Topics

All malware-related topics follow the naming convention: `egov.malware.<action>`

| Topic | Producer | Consumer | Description |
|-------|----------|----------|-------------|
| `egov.malware.file-scan-request` | egov-filestore | egov-malware-detection | Malware scan requests |
| `egov.malware.scan-completed` | egov-malware-detection | (downstream services) | Scan completed events |
| `egov.malware.persist-scan-result` | egov-malware-detection | egov-malware-detection | Async DB persistence |
| `egov.core.notification.email` | egov-malware-detection | egov-notification-mail | Email notifications |

### Topic Naming Convention

```
egov.malware.<action>

Examples:
- egov.malware.file-scan-request  → Request to scan a file
- egov.malware.scan-completed     → Scan has completed
- egov.malware.persist-scan-result → Internal persistence event
```

### Malware Scan Request Schema (INPUT)

Published by `egov-filestore` when a file is uploaded.

```json
{
  "fileStoreId": "abc123-def456",
  "tenantId": "pb",
  "module": "documents",
  "fileName": "document.pdf",
  "contentType": "application/pdf",
  "fileSource": "minio",
  "filePath": "egov-rainmaker-1/pb/documents/December/19/document.pdf",
  "uploadedBy": "user-uuid",
  "uploadedTime": 1703001234567
}
```

### Scan Completed Event Schema (OUTPUT)

Published by `egov-malware-detection` after scan completes.

```json
{
  "id": "scan-uuid",
  "fileStoreId": "abc123-def456",
  "tenantId": "pb",
  "fileName": "document.pdf",
  "filePath": "pb/documents/December/19/document.pdf",
  "fileHash": "sha256-hash",
  "fileSize": 1048576,
  "status": "CLEAN",
  "virusName": null,
  "scanEngine": "ClamAV",
  "scanDurationMs": 150,
  "quarantined": false,
  "notificationSent": false,
  "createdTime": 1703001234567
}
```

---

## Deployment

### Prerequisites

1. **ClamAV** deployed in Kubernetes
2. **Kafka** cluster running
3. **PostgreSQL** database
4. **MinIO/S3** storage configured
5. **egov-filestore** modified to publish Kafka events

### Environment Variables

```yaml
env:
  - name: AWS_ACCESS_KEY
    valueFrom:
      secretKeyRef:
        name: aws-secrets
        key: access-key
  - name: AWS_SECRET_KEY
    valueFrom:
      secretKeyRef:
        name: aws-secrets
        key: secret-key
  - name: SLACK_WEBHOOK_URL
    valueFrom:
      secretKeyRef:
        name: slack-secrets
        key: webhook-url
```

### Build

```bash
cd core-services/egov-malware-detection
mvn clean package -DskipTests
```

### Docker Build

```bash
docker build -t egov-malware-detection:2.9.1-SNAPSHOT .
```

### Kubernetes Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: egov-malware-detection
  namespace: egov
spec:
  replicas: 1
  selector:
    matchLabels:
      app: egov-malware-detection
  template:
    spec:
      containers:
        - name: egov-malware-detection
          image: egov-malware-detection:2.9.1-SNAPSHOT
          ports:
            - containerPort: 8087
          env:
            - name: SPRING_KAFKA_BOOTSTRAP_SERVERS
              value: "kafka.kafka:9092"
            - name: CLAMAV_HOST
              value: "clamav.security.svc.cluster.local"
          resources:
            requests:
              memory: "512Mi"
              cpu: "200m"
            limits:
              memory: "1Gi"
              cpu: "500m"
```

---

## Testing

### EICAR Test File

Use the EICAR test file (standard antivirus test):

```bash
# Create EICAR test file
echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > eicar.txt

# Upload to filestore
curl -X POST http://localhost:8083/filestore/v1/files \
  -F "file=@eicar.txt" \
  -F "tenantId=pb" \
  -F "module=test"
```

**Expected Results:**
1. File detected as `Eicar-Test-Signature`
2. File moved to quarantine bucket
3. Slack notification sent
4. Email alert sent
5. Scan result persisted with status `QUARANTINED`

### Test Clean File

```bash
echo "This is a clean test file" > clean.txt

curl -X POST http://localhost:8083/filestore/v1/files \
  -F "file=@clean.txt" \
  -F "tenantId=pb" \
  -F "module=test"
```

**Expected Results:**
1. File status: `CLEAN`
2. No quarantine
3. No notifications
4. Scan result persisted

### Verify ClamAV Connectivity

```bash
curl http://localhost:8087/malware-detection/health
```

Response:
```json
{
  "status": "UP",
  "service": "egov-malware-detection",
  "clamav": "UP",
  "clamavVersion": "ClamAV 1.0.0/27000/..."
}
```

---

## Troubleshooting

### ClamAV Connection Failed

```
Error: ClamAV connection error: Connection refused
```

**Solution:**
1. Verify ClamAV pod is running: `kubectl get pods -n security`
2. Check ClamAV service: `kubectl get svc -n security`
3. Test connectivity: `nc clamav.security.svc.cluster.local 3310`

### File Not Found in Storage

```
Error: Failed to retrieve file from storage
```

**Solution:**
1. Verify MinIO/S3 credentials
2. Check bucket name configuration
3. Verify file path in the event matches actual storage path

### Email Notification Not Sent

**For Kafka mode:**
1. Verify `egov-notification-mail` service is running
2. Check Kafka topic exists: `egov.core.notification.email`
3. Verify consumer group is consuming messages

**For Direct mode:**
1. Verify SMTP credentials
2. Check mail server connectivity
3. Verify `mail.enabled=true` and `mail.notification.mode=direct`

### Slack Notification Failed

```
Error: Slack webhook returned status code: 404
```

**Solution:**
1. Verify webhook URL is correct
2. Check webhook is still active in Slack workspace
3. Verify network connectivity to Slack API

---

## Changelog

### Version 2.9.1-SNAPSHOT

- Initial release
- ClamAV integration via TCP INSTREAM protocol
- MinIO/S3 file retrieval with SHA-256 hashing
- Quarantine support with configurable delete
- Dual email notification mode (Kafka/Direct)
- Slack webhook integration
- Async persistence via Kafka
- REST API for manual scans and queries

---

## License

MIT License - DIGIT Platform
