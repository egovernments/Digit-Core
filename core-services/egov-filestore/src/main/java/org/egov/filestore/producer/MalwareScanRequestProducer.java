package org.egov.filestore.producer;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.egov.tracer.kafka.CustomKafkaTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.util.LinkedHashMap;
import java.util.Map;

/**
 * Kafka producer for publishing malware scan requests.
 *
 * When a file is uploaded to the filestore, this producer publishes
 * a scan request event to the malware detection service via Kafka.
 *
 * IMPORTANT: This producer is designed to be completely non-blocking.
 * File uploads should NEVER fail or be delayed due to malware scanning.
 * All exceptions are caught and logged - never thrown.
 *
 * Topic: egov.malware.file-scan-request
 * Consumer: egov-malware-detection service
 */
@Service
@Slf4j
public class MalwareScanRequestProducer {

    private final CustomKafkaTemplate<String, Object> kafkaTemplate;
    private final ObjectMapper objectMapper;

    @Value("${kafka.topics.malware.scan.request:egov.malware.file-scan-request}")
    private String malwareScanRequestTopic;

    @Value("${kafka.malware.scan.enabled:false}")
    private boolean malwareScanEnabled;

    @Autowired
    public MalwareScanRequestProducer(CustomKafkaTemplate<String, Object> kafkaTemplate, ObjectMapper objectMapper) {
        this.kafkaTemplate = kafkaTemplate;
        this.objectMapper = objectMapper;
    }

    /**
     * Checks if malware scanning is enabled.
     * @return true if malware scan is enabled
     */
    public boolean isMalwareScanEnabled() {
        return malwareScanEnabled;
    }

    /**
     * Publishes a malware scan request for the uploaded file.
     * This method is completely non-blocking - all exceptions are caught and logged.
     *
     * @param fileStoreId  Unique identifier of the file in the filestore
     * @param tenantId     Tenant ID of the file owner
     * @param module       Module that uploaded the file
     * @param fileName     Original file name
     * @param contentType  MIME type of the file
     * @param fileSource   Storage backend (minio, AzureBlobStorage, etc.)
     * @param filePath     Full path of the file in storage
     * @param uploadedBy   UUID of the user who uploaded the file
     * @param uploadedTime Timestamp when the file was uploaded (epoch millis)
     */
    public void publishScanRequest(String fileStoreId, String tenantId, String module,
                                   String fileName, String contentType, String fileSource,
                                   String filePath, String uploadedBy, Long uploadedTime) {
        // Early return if disabled - no processing needed
        if (!malwareScanEnabled) {
            log.debug("[MALWARE-PRODUCER] Malware scanning is DISABLED, skipping for fileStoreId: {}", fileStoreId);
            return;
        }

        try {
            Map<String, Object> scanRequest = new LinkedHashMap<>();
            scanRequest.put("fileStoreId", fileStoreId);
            scanRequest.put("tenantId", tenantId);
            scanRequest.put("module", module);
            scanRequest.put("fileName", fileName);
            scanRequest.put("contentType", contentType);
            scanRequest.put("fileSource", fileSource);
            scanRequest.put("filePath", filePath);
            scanRequest.put("uploadedBy", uploadedBy);
            scanRequest.put("uploadedTime", uploadedTime);

            // Convert Map to JSON string since Kafka is configured with StringSerializer
            String scanRequestJson = objectMapper.writeValueAsString(scanRequest);

            // Fire-and-forget - Kafka producer timeout configs ensure this doesn't block
            kafkaTemplate.send(malwareScanRequestTopic, scanRequestJson);
            log.info("[MALWARE-PRODUCER] Published scan request for fileStoreId: {}", fileStoreId);
        } catch (JsonProcessingException e) {
            // JSON serialization failed - log and continue
            log.warn("[MALWARE-PRODUCER] Failed to serialize scan request for fileStoreId: {} - {}",
                    fileStoreId, e.getMessage());
        } catch (Exception e) {
            // NEVER throw exception - file upload must succeed regardless of Kafka status
            log.warn("[MALWARE-PRODUCER] Failed to publish scan request for fileStoreId: {} - {}",
                    fileStoreId, e.getMessage());
        }
    }
}
